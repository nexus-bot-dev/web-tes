<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Panel VPN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/dashboard.html">Panel Admin Vpn</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item me-2">
                    <button class="btn btn-outline-light" id="toggleServerForm">âž• Kelola Server</button>
                </li>
                <li class="nav-item">
                    <button class="btn btn-danger" id="logoutBtn">Logout</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="mb-4">Buat Akun VPN Baru</h1>
    
    <div id="serverFormContainer" class="card p-4 mb-4 d-none">
        <h5 class="card-title">Tambah Server Baru</h5>
        <div id="serverAlert" class="alert d-none" role="alert"></div>
        <form id="addServerForm">
            <input type="text" class="form-control mb-2" id="serverName" placeholder="Nama Server (Contoh: SG-Baru)" required>
            <input type="text" class="form-control mb-2" id="serverDomain" placeholder="Domain API (Contoh: rw1.rf-backend.icu)" required>
            <input type="text" class="form-control mb-3" id="serverAuthKey" placeholder="Auth Key API" required>
            <button type="submit" class="btn btn-primary w-100">Simpan Server</button>
        </form>
    </div>

    <div id="statusMessage" class="alert d-none" role="alert"></div>

    <form id="createAccountForm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="serverSelect" class="form-label">Pilih Server</label>
                <select class="form-select" id="serverSelect" required>
                    <option value="">-- Muat Server --</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="endpointType" class="form-label">Tipe Akun</label>
                <select class="form-select" id="endpointType" required>
                    <option value="ssh">SSH/Stunnel</option>
                    <option value="vmess">VMess</option>
                    <option value="trojan">Trojan</option>
                    <option value="vless">VLess</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="col-md-6 mb-3" id="passwordField">
                <label for="password" class="form-label">Password</label>
                <input type="text" class="form-control" id="password">
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="exp" class="form-label">Masa Aktif (Hari)</label>
                <input type="number" class="form-control" id="exp" value="7" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="limitip" class="form-label">Limit IP</label>
                <input type="number" class="form-control" id="limitip" value="1" required>
            </div>
             <div class="col-md-4 mb-3 d-none" id="quotaField">
                <label for="quota" class="form-label">Quota (GB)</label>
                <input type="number" class="form-control" id="quota" value="10">
            </div>
        </div>

        <button type="submit" class="btn btn-success mt-3">Buat Akun</button>
    </form>
    
    <div id="accountDetails" class="mt-5 d-none">
        <h4 class="mb-3">Detail Akun Berhasil Dibuat:</h4>
        <div id="accountCard" class="card shadow-sm">
            </div>
    </div>
</div>

<script>
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        window.location.href = '/login.html'; // Redirect jika belum login
    }

    // Variabel DOM
    const serverSelect = document.getElementById('serverSelect');
    const statusMessage = document.getElementById('statusMessage');
    const endpointType = document.getElementById('endpointType');
    const passwordField = document.getElementById('passwordField');
    const quotaField = document.getElementById('quotaField');
    const serverFormContainer = document.getElementById('serverFormContainer');
    const serverAlert = document.getElementById('serverAlert');
    const accountCard = document.getElementById('accountCard');
    const accountDetails = document.getElementById('accountDetails');


    // --- 1. Fungsi Utility ---
    function showAlert(message, type, target) {
        target.textContent = message;
        target.className = `alert ${type}`;
        target.classList.remove('d-none');
        setTimeout(() => { target.classList.add('d-none'); }, 5000);
    }

    // --- 2. Load Servers ---
    async function loadServers() {
        serverSelect.innerHTML = '<option value="">-- Memuat... --</option>';
        try {
            const response = await fetch('/api/get-servers', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const result = await response.json();
            
            if (response.ok && result.status) {
                serverSelect.innerHTML = '<option value="">-- Pilih Server --</option>';
                result.servers.forEach(server => {
                    const option = document.createElement('option');
                    option.value = server.id;
                    option.textContent = `${server.name} (${server.domain})`;
                    serverSelect.appendChild(option);
                });
            } else {
                 serverSelect.innerHTML = '<option value="">-- Gagal memuat server --</option>';
                 showAlert(result.message || 'Gagal memuat server.', 'alert-danger', statusMessage);
            }
        } catch (error) {
            serverSelect.innerHTML = '<option value="">-- Error koneksi server --</option>';
            showAlert('Error koneksi saat memuat server.', 'alert-danger', statusMessage);
        }
    }

    // --- 3. Display Account Details ---
    function displayAccountDetails(data, type, serverDomain) {
        accountCard.innerHTML = '';
        accountDetails.classList.remove('d-none');
        
        let html = `
            <div class="card-body">
                <h5 class="card-title text-success">${type.toUpperCase()} Account Created!</h5>
                <table class="table table-sm table-borderless mt-3">
                    <tbody>
                        <tr><th>Tipe Akun</th><td>: <span class="badge bg-primary">${type.toUpperCase()}</span></td></tr>
                        <tr><th>Server</th><td>: ${serverDomain}</td></tr>
                        <tr><th>Username</th><td>: <strong>${data.user || 'N/A'}</strong></td></tr>
                        <tr><th>Password</th><td>: <strong>${data.password || 'N/A'}</strong></td></tr>
                        <tr><th>Masa Aktif</th><td>: ${data.exp_date || data.expired || 'N/A'}</td></tr>
        `;
        
        if (type === 'ssh') {
            html += `<tr><th>Limit IP</th><td>: ${data.limitip || '1'}</td></tr>`;
            html += `<tr><th>Host / IP</th><td>: ${data.host || 'N/A'}</td></tr>`;
            html += `<tr><th>Port SSH</th><td>: ${data.port_ssh || '22'}</td></tr>`;
        } else {
            html += `<tr><th>UUID/ID</th><td>: <span class="text-info text-break">${data.uuid || data.id || 'N/A'}</span></td></tr>`;
            html += `<tr><th>Quota</th><td>: ${data.quota || 'Unlimited'}</td></tr>`;
        }

        if (data.config_link || data.link_vmess || data.link_trojan || data.link_vless) {
            const link = data.config_link || data.link_vmess || data.link_trojan || data.link_vless;
             html += `<tr><td colspan="2"><button class="btn btn-sm btn-info mt-2 w-100" onclick="copyConfig('${link}')">Salin Link Konfigurasi</button></td></tr>`;
        }

        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        accountCard.innerHTML = html;
    }

    function copyConfig(text) {
        navigator.clipboard.writeText(text).then(() => {
            showAlert('Link Konfigurasi Berhasil Disalin!', 'alert-info', statusMessage);
        }).catch(err => {
            console.error('Gagal menyalin:', err);
            showAlert('Gagal menyalin link.', 'alert-danger', statusMessage);
        });
    }

    // --- 4. Form Create Account ---
    document.getElementById('createAccountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const type = endpointType.value;
        const serverOption = serverSelect.options[serverSelect.selectedIndex];
        const serverDomain = serverOption.getAttribute('data-domain'); // Ambil domain dari elemen yang dimuat

        const data = {
            server_id: serverSelect.value,
            endpoint_type: type,
            user: document.getElementById('username').value,
            exp: document.getElementById('exp').value,
            limitip: document.getElementById('limitip').value
        };
        
        if (type === 'ssh') {
            data.password = document.getElementById('password').value;
        } else {
            data.quota = document.getElementById('quota').value;
        }

        if (!data.server_id) {
             showAlert('Pilih server terlebih dahulu.', 'alert-warning', statusMessage);
             return;
        }

        try {
            const response = await fetch('/api/create-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            accountDetails.classList.add('d-none'); // Sembunyikan hasil sebelumnya

            if (response.ok && result.status === true) {
                showAlert('Akun berhasil dibuat!', 'alert-success', statusMessage);
                displayAccountDetails(result.data || result, type, serverDomain);
            } else {
                showAlert('Gagal membuat akun: ' + (result.message || 'Respons tidak diketahui.'), 'alert-danger', statusMessage);
            }

        } catch (error) {
            showAlert('Terjadi kesalahan koneksi atau server.', 'alert-danger', statusMessage);
        }
    });
    
    // --- 5. Form Add Server ---
    document.getElementById('addServerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const serverData = {
            name: document.getElementById('serverName').value,
            domain: document.getElementById('serverDomain').value,
            auth_key: document.getElementById('serverAuthKey').value
        };

        try {
            const response = await fetch('/admin/add-server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(serverData)
            });
            const result = await response.json();

            if (response.ok && result.status) {
                showAlert('Server berhasil ditambahkan!', 'alert-success', serverAlert);
                document.getElementById('addServerForm').reset();
                loadServers();
            } else {
                showAlert('Gagal menambahkan server: ' + (result.message || 'Error.'), 'alert-danger', serverAlert);
            }
        } catch (error) {
             showAlert('Error koneksi saat menambahkan server.', 'alert-danger', serverAlert);
        }
    });

    // --- 6. Toggle Field Input (Password/Quota) & Server Form ---
    endpointType.addEventListener('change', (e) => {
        const type = e.target.value;
        if (type === 'ssh') {
            passwordField.classList.remove('d-none');
            quotaField.classList.add('d-none');
            document.getElementById('password').setAttribute('required', 'required');
            document.getElementById('quota').removeAttribute('required');
        } else {
            passwordField.classList.add('d-none');
            quotaField.classList.remove('d-none');
            document.getElementById('password').removeAttribute('required');
            document.getElementById('quota').setAttribute('required', 'required');
        }
    });
    
    document.getElementById('toggleServerForm').addEventListener('click', () => {
        serverFormContainer.classList.toggle('d-none');
    });

    // --- 7. Logout ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken'); 
        window.location.href = '/login.html';
    });
    
    // Patch untuk mengambil data-domain saat memuat server
    serverSelect.addEventListener('change', () => {
        const selectedOption = serverSelect.options[serverSelect.selectedIndex];
        // Tambahkan atribut data-domain ke opsi terpilih untuk memudahkan pengambilan
        const selectedServer = result.servers.find(s => s.id === selectedOption.value);
        if (selectedServer) {
            selectedOption.setAttribute('data-domain', selectedServer.domain);
        }
    });


    // Jalankan saat halaman dimuat
    loadServers();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
